-- Load @vir Library
local library = loadstring(game:HttpGet('https://raw.githubusercontent.com/fraudcharge/vir/main/@vir/Library.lua'))()
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Player = Players.LocalPlayer

------------------------------------------------------------
-- üì¶ Create GUI
------------------------------------------------------------
local window = library:CreateWindow("@fraudulentcharge Chainsaw Man Script")
local FarmTab = window:CreateTab("AutoFarm")
local PlayerTab = window:CreateTab("Player")
local ESPTab = window:CreateTab("ESP")
local HalloweenTab = window:CreateTab("Halloween")

------------------------------------------------------------
-- ‚öôÔ∏è Utility
------------------------------------------------------------
local function notify(title, content)
    library:Notify(title .. ": " .. content)
end

local function touchPart(part)
    if part and part:IsA("BasePart") and Player and Player.Character and Player.Character:FindFirstChild("HumanoidRootPart") then
        pcall(function()
            firetouchinterest(Player.Character.HumanoidRootPart, part, 0)
            task.wait(0.05)
            firetouchinterest(Player.Character.HumanoidRootPart, part, 1)
        end)
    end
end

------------------------------------------------------------
-- üîÅ AutoFarm
------------------------------------------------------------
local autofarmRunning = false
local autofarmThread
local lastEquipTime = 0

local function getCharacter()
    while not Player.Character or not Player.Character:FindFirstChild("HumanoidRootPart") do
        Player.CharacterAdded:Wait()
        task.wait()
    end
    return Player.Character
end

local function equipKatana()
    if tick() - lastEquipTime < 3 then return end
    lastEquipTime = tick()

    local char = getCharacter()
    local backpack = Player:FindFirstChild("Backpack")
    if backpack then
        local katana = backpack:FindFirstChild("Katana") or char:FindFirstChild("Katana")
        if katana and not char:FindFirstChild("Katana") then
            char.Humanoid:EquipTool(katana)
        end
    end
end

local function closestFiend()
    local npcs = Workspace:FindFirstChild("Living")
    local closest, minDist = nil, math.huge
    if npcs then
        for _, npc in pairs(npcs:GetChildren()) do
            if npc.Name:lower():find("fiend") and npc:FindFirstChild("HumanoidRootPart") and npc:FindFirstChild("Humanoid") and npc.Humanoid.Health > 0 then
                local char = getCharacter()
                local hrp = char and char:FindFirstChild("HumanoidRootPart")
                if hrp then
                    local dist = (hrp.Position - npc.HumanoidRootPart.Position).Magnitude
                    if dist < minDist then
                        closest = npc
                        minDist = dist
                    end
                end
            end
        end
    end
    return closest
end

local function orbitAndAttack(npc)
    local char = getCharacter()
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    local npcHRP = npc and npc:FindFirstChild("HumanoidRootPart")
    if not hrp or not npcHRP then return end

    local orbitSpeed = 6
    local orbitRadius = 7

    local conn
    conn = RunService.RenderStepped:Connect(function()
        if not autofarmRunning or not npc or not npc.Parent or not npc:FindFirstChild("Humanoid") or npc.Humanoid.Health <= 0 then
            if conn then conn:Disconnect() end
            return
        end

        equipKatana()
        local angle = tick() * orbitSpeed
        local offset = Vector3.new(math.cos(angle) * orbitRadius, 0, math.sin(angle) * orbitRadius)
        local targetPos = npcHRP.Position + offset
        hrp.CFrame = hrp.CFrame:Lerp(CFrame.new(targetPos, npcHRP.Position), 0.4)

        if ReplicatedStorage:FindFirstChild("events") and ReplicatedStorage.events:FindFirstChild("remote") then
            ReplicatedStorage.events.remote:FireServer("NormalAttack")
        end
    end)
end

FarmTab:CreateButton("Toggle AutoFarm", function()
    autofarmRunning = not autofarmRunning
    notify("AutoFarm", autofarmRunning and "‚úÖ Enabled" or "‚ùå Disabled")

    if autofarmRunning then
        autofarmThread = task.spawn(function()
            local quest_boy = Workspace:WaitForChild("DialogNPCs"):WaitForChild("grown up boy"):WaitForChild("HumanoidRootPart")

            while autofarmRunning do
                local char = getCharacter()
                local hrp = char and char:FindFirstChild("HumanoidRootPart")
                if not hrp then task.wait(0.1) continue end

                local questGui = Player:FindFirstChild("PlayerGui") and Player.PlayerGui:FindFirstChild("Quest")
                local questActive = false
                if questGui and questGui:FindFirstChild("quest") and questGui:FindFirstChild("progress") then
                    local quest = questGui.quest
                    local progress = questGui.progress
                    if tostring(quest.Value):lower():find("fiends") and tonumber(progress.Value) < tonumber((questGui.max and questGui.max.Value) or 3) then
                        questActive = true
                    end
                end

                if not questActive then
                    if hrp then
                        local dist = (hrp.Position - quest_boy.Position).Magnitude
                        if dist > 8 then
                            hrp.CFrame = CFrame.new(quest_boy.Position + Vector3.new(0,0,-2), quest_boy.Position)
                        else
                            local prompt = quest_boy.Parent:FindFirstChildOfClass("ProximityPrompt")
                            if prompt then pcall(fireproximityprompt, prompt) end
                        end
                    end
                else
                    local npc = closestFiend()
                    if npc then
                        orbitAndAttack(npc)
                        repeat task.wait(0.1) until not npc or not npc.Parent or not npc:FindFirstChild("Humanoid") or npc.Humanoid.Health <= 0 or not autofarmRunning
                    else
                        task.wait(0.5)
                    end
                end

                task.wait(0.3)
            end
        end)
    else
        if autofarmThread then
            task.cancel(autofarmThread)
            autofarmThread = nil
        end
    end
end)

------------------------------------------------------------
-- ‚úÖ Auto Complete Quest
------------------------------------------------------------
local questOn = false
FarmTab:CreateButton("Toggle Auto Complete Quest", function()
    questOn = not questOn
    notify("Auto Complete Quest", questOn and "‚úÖ Enabled" or "‚ùå Disabled")

    if questOn then
        task.spawn(function()
            while questOn do
                task.wait(0.2)
                local interactable = Workspace:FindFirstChild("Interactable")
                if interactable then
                    local goals = interactable:FindFirstChild("pizzagoals")
                    local couch = interactable:FindFirstChild("CouchGoal")

                    if goals then
                        for _, part in ipairs(goals:GetDescendants()) do
                            if not questOn then break end
                            if part:IsA("BasePart") then
                                touchPart(part)
                                task.wait(0.1)
                            end
                        end
                    end

                    if couch and couch:IsA("BasePart") then
                        touchPart(couch)
                        task.wait(0.2)
                    end
                else
                    task.wait(0.2)
                end
            end
        end)
    end
end)

------------------------------------------------------------
-- üßç Player ESP
------------------------------------------------------------
local playerEspEnabled = false
local playerEspObjects = {}
ESPTab:CreateButton("Toggle Player ESP", function()
    playerEspEnabled = not playerEspEnabled
    notify("Player ESP", playerEspEnabled and "‚úÖ Enabled" or "‚ùå Disabled")

    if playerEspEnabled then
        task.spawn(function()
            while playerEspEnabled do
                for _, obj in ipairs(playerEspObjects) do if obj and obj.Parent then obj:Destroy() end end
                table.clear(playerEspObjects)

                for _, plr in ipairs(Players:GetPlayers()) do
                    if plr ~= Player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                        local highlight = Instance.new("Highlight")
                        highlight.FillColor = Color3.fromRGB(0, 255, 100)
                        highlight.OutlineColor = Color3.fromRGB(0, 255, 100)
                        highlight.Adornee = plr.Character
                        highlight.Parent = plr.Character
                        table.insert(playerEspObjects, highlight)
                    end
                end

                task.wait(1)
            end

            for _, obj in ipairs(playerEspObjects) do if obj and obj.Parent then obj:Destroy() end end
            table.clear(playerEspObjects)
        end)
    else
        for _, obj in ipairs(playerEspObjects) do if obj and obj.Parent then obj:Destroy() end end
        table.clear(playerEspObjects)
    end
end)
